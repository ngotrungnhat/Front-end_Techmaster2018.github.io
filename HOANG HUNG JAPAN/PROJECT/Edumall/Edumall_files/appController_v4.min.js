var app=angular.module("csChatApp.controllers",[])
app.directive("fileModel",["$parse",function($parse){return{restrict:"A",link:function(scope,element,attrs){var model=$parse(attrs.fileModel),modelSetter=model.assign
element.bind("change",function(){scope.$apply(function(){modelSetter(scope,element[0].files[0]),scope.onFileSelected(scope)})})}}}]),app.controller("AppController",["$scope","$http","$location","DomainService","$window","$sce","TranslateService","$filter",function($scope,$http,$location,DomainService,$window,$sce,TranslateService,$filter){function popupCenter(url,title){var newWindow=window.open(url,title)
window.focus&&newWindow.focus()}function endConversation(){var endChat={visitorId:$scope.chatState.visitor_id,serviceId:$scope.chatState.service_id,conversationId:$scope.chatState.conversation_id}
send(LEAVE_CONVERSATION,endChat),$scope.chatState.conversation_id="-1",$scope.chatState.agent_name=null
var mes=$filter("translate")("LBL_CHAT_ENDED"),logChatData=new Message(null,3,mes)
$scope.chatState.history.push(logChatData),$scope.listMessage.push(logChatData),$scope.isLike=!1,$scope.isDislike=!1,$scope.chatState.isLike=!1,$scope.chatState.isDislike=!1,saveChatStateToStorage(),$scope.isRating=!1,$scope.allowRating=!1,$scope.commentMessage=new Comment,$scope.agentName=$scope.agentNameDefault,$scope.agentDescription=$scope.agentDescriptionDefault,$scope.avatar=$scope.agentAvatarDefault,$scope.changeLandingSendState(!1),$(".chat-area").scrollTop($(".chat-area").prop("scrollHeight"))}function stopNotifyTypingToCust(){$scope.isKeyPress=!1
var req={conversationId:$scope.chatState.conversation_id}
send(NOTIFY_STOP_TYPING,req)}function initWorkspace(){checkChatStatus(),restoreChatState()}function checkChatStatus(){if(null!=localStorage.getItem("chatState_undefined")&&localStorage.removeItem("chatState_undefined"),null!=localStorage.getItem("chatState_"+$scope.domainId)?($scope.chatState=JSON.parse(localStorage.getItem("chatState_"+$scope.domainId)),null!=parentUsername&&""!=parentUsername&&$scope.chatState.visitor_name!=parentUsername&&($scope.chatState=null)):$scope.chatState=null,null===$scope.chatState||"undefined"===$scope.chatState)return log("chat_state = null"),void($scope.chatState=new ChatState)
void 0==$scope.chatState.enableSound&&($scope.chatState.enableSound=!0,saveChatStateToStorage())
for(var i=0;i<$scope.chatState.history.length;i++){var temp=jQuery.extend(!0,{},$scope.chatState.history[i])
temp.content=getMessageChat(temp.content),$scope.listMessage.push(temp)}return $scope.chatState}function markLanding(){if(!getCookie("chatState_sourceUrl_"+$scope.domainId)){var host=document.location.host
parent!==window&&(host=document.referrer)
var sourceURL={landing:host,referrer:$scope.referrer,isSentBefore:!1,test:"1"}
setCookie("chatState_sourceUrl_"+$scope.domainId,JSON.stringify(sourceURL),"")}}function restoreChatState(){if(null!==$scope.chatState&&"undefined"!==$scope.chatState){log("restoring chat state")
var requestResumeSession={visitorId:$scope.chatState.visitor_id,service_id:$scope.chatState.service_id,conversationId:$scope.chatState.conversation_id,domain:$scope.domainCode}
sendWaitForConnection(CUSTOMER_RESUMING_REQUEST,requestResumeSession)}}function getQueryString(){isMobile.any()&&($scope.isMobile=!0)
var q=$location.search(),queryString=atob(decodeURIComponent(q.key)),domain=getParameterByName("domain",queryString)
parentUsername=getParameterByName("username",queryString)
getParameterByName("color",queryString)
parentEmail=getParameterByName("email",queryString),parentPhone=getParameterByName("phone",queryString),isAuto=getParameterByName("auto",queryString),pageTitle=getParameterByName("pageTitle",queryString),referrer=getParameterByName("referrer",queryString),hidePopup=1==getParameterByName("hide",queryString),null!=parentUsername&&""!=parentUsername&&($scope.isDisable.username=!0),null!=parentEmail&&""!=parentEmail&&($scope.isDisable.email=!0),null!=parentPhone&&""!=parentPhone&&($scope.isDisable.phone=!0),null!=pageTitle&&""!=pageTitle&&($scope.pageTitle=pageTitle),null!=referrer&&""!=referrer&&($scope.referrer=referrer)
var language=getParameterByName("language",queryString)
DomainService.getChat(domain,parentUsername).then(function(data){if(null!=data&&void 0!=data&&($scope.useFacebook=1==data.data.useFacebook,null!=data.data.pageId&&""!=data.data.pageId&&($scope.pageId=data.data.pageId),$scope.useFacebook||(CS_WEB_PUSH=data.data.chatServer,uploadUrl=data.data.uploadUrl,webPush.connect(CS_WEB_PUSH,0)),$scope.serviceName=data.data.domainValue,$scope.domainCode=data.data.domainCode,$scope.domainPath=data.data.path,$scope.accountId=data.data.accountId,null!=data.data.color&&""!=data.data.color&&($scope.backgroundColor=data.data.color),null!=data.data.offTitle&&""!=data.data.offTitle&&($scope.offTitle=data.data.offTitle),null!=data.data.onTitle&&""!=data.data.onTitle&&($scope.onTitle=data.data.onTitle),null!=data.data.avatar&&""!=data.data.avatar&&($scope.agentAvatarDefault=data.data.avatar),null!=data.data.agentName&&""!=data.data.agentName&&($scope.agentNameDefault=data.data.agentName),null!=data.data.agentTitle&&""!=data.data.agentTitle&&($scope.agentDescriptionDefault=data.data.agentTitle),null!=data.data.agentBusy&&""!=data.data.agentBusy&&($scope.agentBusyDefault=data.data.agentBusy),null!=data.data.offlineInfo&&""!=data.data.offlineInfo&&($scope.offlineInfo=data.data.offlineInfo),null!=data.data.sendSuccess&&""!=data.data.sendSuccess&&($scope.offlineSuccess=data.data.sendSuccess),null!=data.data.sendSuccess&&""!=data.data.sendSuccess&&($scope.offlineSuccess=data.data.sendSuccess),null!=data.data.logoUrl&&""!=data.data.logoUrl&&($scope.homepage=data.data.logoUrl),null!=data.data.logoImage&&""!=data.data.logoImage&&($scope.logo=data.data.logoImage),null!=data.data.logoDescription&&""!=data.data.logoDescription&&($scope.titleLogo=data.data.logoDescription),$scope.enableEmail=1==data.data.enableEmail,$scope.requireEmail=1==data.data.requiredEmail,$scope.enablePhone=1==data.data.enablePhone,$scope.requirePhone=1==data.data.requiredPhone,$scope.autoPopup=1==data.data.autoPopup,$scope.autoPopup&&($scope.autoMessage=data.data.autoMessage,$scope.autoName=data.data.autoName,$scope.autoType=data.data.autoType,$scope.autoTime=data.data.autoTime,$scope.autoService=data.data.autoServiceId,$scope.autoDelay=data.data.autoDelay),""==language||"vi"!=language&&"en"!=language?$scope.language=data.data.language:$scope.language=language,TranslateService.translate($scope.language),!$scope.useFacebook&&null!=data.data.listService&&0!=data.data.listService.length)){if($.each(data.data.listService,function(ind,val){$scope.listServiceStr+=val.serviceId+";"}),$scope.domainId=data.data.domainId,null==localStorage.getItem("chatState_devicekey_"+$scope.domainId)){var device_key=encodeURIComponent(btoa((new Date).getTime()))
localStorage.setItem("chatState_devicekey_"+$scope.domainId,device_key)}if(markLanding(),initWorkspace(),0==data.data.requiredEmail&&0==data.data.requiredPhone?$scope.needSignin=!1:$scope.needSignin=!0,$scope.listService=data.data.listService,1==$scope.listService.length)$scope.chatState.service_id=$scope.listService[0].serviceId
else{var selectName=$filter("translate")("LBL_SELECT_ONE_SERVICE")
$scope.listService.unshift({serviceId:"-1",serviceName:selectName})}$scope.login.selectedService=$scope.listService[0],$scope.login.content="",$scope.visitorName=$scope.chatState.visitor_name,$scope.visitorEmail=$scope.chatState.visitor_email,$scope.visitor_phone=$scope.chatState.visitor_phone,saveChatStateToStorage()}})}function send(service,data){var packet={service:service,data:data}
if(webPush.send(packet),log("Client send: "+JSON.stringify(packet)),service===MESSAGE){var senderAgentId=null,content=data.message,logChat=new Message(senderAgentId,1,content),logChatData=new Message(senderAgentId,1,getMessageChat(content))
$scope.chatState.history.push(logChat),$scope.listMessage.push(logChatData),saveChatStateToStorage()}}function sendWaitForConnection(service,data){var packet={service:service,data:data}
if(webPush.sendWait(packet),log("Client sendWait: "+JSON.stringify(packet)),service===MESSAGE){var senderAgentId=null,content=data.message,logChat=new Message(senderAgentId,1,content),logChatData=new Message(senderAgentId,1,getMessageChat(content))
$scope.chatState.history.push(logChat),$scope.listMessage.push(logChatData),saveChatStateToStorage()}}function getMessageChat(text){return $sce.trustAsHtml(urlify(htmlEncode(text).replace(/(?:\r\n|\r|\n)/g,"<br/>")))}function urlify(text){var urlRegex=/(https?:\/\/[^\s]+)/g
return text.replace(urlRegex,function(url){return url.trim()==text.trim()&&isImageLink(url)?'<a href="'+url+'" target="_blank"><img src="'+url+'" style="height:110px;"/></a>':'<a href="'+url+'" target="_blank">'+url+"</a>"})}function htmlEncode(value){return $("<div/>").text(value).html()}function saveChatStateToStorage(){localStorage.setItem("chatState_"+$scope.domainId,JSON.stringify($scope.chatState))}function sessionLogout(){$scope.chatState.agent_name="",$scope.chatState.agent_group="",1==$scope.listService.length||($scope.chatState.service_id=-1),$scope.chatState.isLike=!1,$scope.chatState.isDislike=!1,$scope.sendOfflineError=!1,null!=$scope.chatState.visitor_name&&""!=$scope.chatState.visitor_name?($scope.visitorName=null==$scope.chatState.visitor_name?"":$scope.chatState.visitor_name,$scope.visitorEmail=null==$scope.chatState.visitor_email?"":$scope.chatState.visitor_email,$scope.visitorPhone=null==$scope.chatState.visitor_phone?"":$scope.chatState.visitor_phone):($scope.visitorName=parentUsername,$scope.visitorEmail=parentEmail,$scope.visitorPhone=parentPhone),$scope.login.username=$scope.visitorName,$scope.login.email=$scope.visitorEmail,$scope.login.phone=$scope.visitorPhone,$scope.chatState.conversation_id="-1",$scope.chatState.history=[],$scope.listMessage=[],$scope.agentName=$scope.agentNameDefault,$scope.agentDescription=$scope.agentDescriptionDefault,$scope.avatar=$scope.agentAvatarDefault,$scope.isChatting=!1,$scope.isSignin=!1}function restoreChatBox(){$scope.isChatting=!0,$scope.chatState.chat_windows_maximum===!0?(notifyNewMessage("openChatBox"),$scope.maximize=!0):(notifyNewMessage(hidePopup?$scope.isChatting?"closeChatBox":"closeChatBoxHide":"closeChatBox"),$scope.maximize=!1),$scope.sendOfflineError=!1,""==$scope.chatState.agent_name?($scope.agentName=$scope.agentNameDefault,$scope.agentDescription=$scope.agentDescriptionDefault,$scope.avatar=$scope.agentAvatarDefault):($scope.agentName=$scope.chatState.agent_name,$scope.agentDescription=$scope.chatState.agent_group,$scope.avatar=$scope.chatState.agent_avatar,$scope.allowRating=!0),""!==$scope.chatState.visitor_name?($scope.isSignin=!0,$scope.visitorName=null==$scope.chatState.visitor_name?"":$scope.chatState.visitor_name,$scope.visitorEmail=null==$scope.chatState.visitor_email?"":$scope.chatState.visitor_email,$scope.visitorPhone=null==$scope.chatState.visitor_phone?"":$scope.chatState.visitor_phone,$scope.login.username=$scope.visitorName,$scope.login.email=$scope.visitorEmail,$scope.login.phone=$scope.visitorPhone,$scope.userInfo.username=$scope.visitorName,$scope.userInfo.email=$scope.visitorEmail,$scope.userInfo.phone=$scope.visitorPhone,$scope.isLike=$scope.chatState.isLike,$scope.isDislike=$scope.chatState.isDislike):$scope.isSignin=!1}function displayMessage(evt){evt=JSON.parse(evt.data),1==evt.id&&$scope.openChatBox(),2==evt.id&&$(".chat-area").scrollTop($(".chat-area").prop("scrollHeight")),$scope.$digest()}function getHostName(url){var match=url.match(/:\/\/(www[0-9]?\.)?(.[^\/:]+)/i)
return null!=match&&match.length>2&&"string"==typeof match[2]&&match[2].length>0?match[2]:null}function setCookie(name,value,days){var expires
if(days){var date=new Date
date.setTime(date.getTime()+24*days*60*60*1e3),expires=";expires="+date.toUTCString()}else expires=""
document.cookie=name+"="+value+expires+";path=/"}function getCookie(cname){for(var name=cname+"=",decodedCookie=decodeURIComponent(document.cookie),ca=decodedCookie.split(";"),i=0;i<ca.length;i++){for(var c=ca[i];" "==c.charAt(0);)c=c.substring(1)
if(0==c.indexOf(name))return c.substring(name.length,c.length)}return""}function isImageLink(url){var regex=/\.(jpg|jpeg|tiff|gif|png)$/
return regex.test(url.toLowerCase())}function requestFirstLogin(){if(isFirstLogin===!1){log("-------------------------------request login first time-------------------------------")
var chatState
chatState=null!=localStorage.getItem("chatState_"+$scope.domainId)?JSON.parse(localStorage.getItem("chatState_"+$scope.domainId)):$scope.chatState
var response=new $.jqx.response,os=response.os,browser=response.browser,device=response.device,host=document.location.host
parent!==window&&(host=document.referrer)
var requestLogin={visitorId:chatState.visitor_id,ip:userIp,country_name:city,host:getHostName(host),domain:$scope.domainCode,os:os.name+" "+os.version+" "+os.platform,browser:browser.name+" "+browser.version,device_type:device.type,accountId:$scope.accountId}
if($scope.login.username||$scope.login.email||$scope.login.phone){var infoVisitor={name:$scope.login.username?$scope.login.username:"",email:$scope.login.email?$scope.login.email:"",phone:$scope.login.phone?$scope.login.phone:""}
send(UPDATE_VISITOR_INFO,infoVisitor)}send(CUSTOMER_LOGIN,requestLogin)
var url={url:host,title:$scope.pageTitle?$scope.pageTitle:null,referrer:$scope.referrer?$scope.referrer:null}
send(VISITOR_VISIT_PATH_URL,url)}}function notifyNewMessage(action){var data={id:6,type:action}
parent.postMessage(JSON.stringify(data),"*");parent.postMessage(action, "*");}$scope.$window=$window,webPush.onConnected=function(){$scope.disconnectChat=!1,$scope.connecting=!1,$scope.$digest()},webPush.onDisconnected=function(){$scope.disconnectChat=!0,$scope.connecting=!1,$scope.$digest()}
var parentUsername="",parentEmail="",parentPhone="",isAuto=!0,hidePopup=!1,pageTitle="",referrer=""
$scope.isDisable={username:!1,email:!1,phone:!1},$scope.backgroundColor="#0074b0",$scope.offTitle=$filter("translate")("LBL_LEAVE_MESSAGE"),$scope.onTitle=$filter("translate")("LBL_CHAT_US"),$scope.agentNameDefault=$filter("translate")("LBL_AGENT_DEFAULT"),$scope.agentDescriptionDefault=$filter("translate")("LBL_DESCRIPTION_DEFAULT"),$scope.agentAvatarDefault="https://s2.caresoft.vn:8090/images/avatar_simple_agent.png",$scope.offlineInfo=$filter("translate")("LBL_OFFLINE_INFO"),$scope.offlineSuccess=$filter("translate")("LBL_OFFLINE_SUCCESS"),$scope.agentBusyDefault=$filter("translate")("LBL_NO_AGENT_AVAILABLE"),$scope.homepage="#",$scope.titleLogo="Powered by Caresoft",$scope.logo="images/cs.png",$scope.newMessage=0,$scope.chat=!1,$scope.message=!1,$scope.survey=!1,$scope.myFile="",$scope.maximize=!1,$scope.isChatting=!1,$scope.isRating=!1,$scope.sentNotify=!1,$scope.allowRating=!1,$scope.isSignin=!1,$scope.isClickSignin=!1,$scope.isEditInfo=!1,$scope.isClickOption=!1,$scope.isConfirmEnd=!1,$scope.requiredName=!1,$scope.requiredEmail=!1,$scope.requiredPhone=!1,$scope.requiredContent=!1,$scope.requireService=!1,$scope.invalidEmail=!1,$scope.invalidPhone=!1,$scope.disconnectChat=!0,$scope.connecting=!0,$scope.uploading=!1,$scope.isOffline=!1,$scope.enableEmail=!0,$scope.requireEmail=!0,$scope.enablePhone=!1,$scope.requirePhone=!1,$scope.sendOfflineError=!1,$scope.isSendOffline=!1,$scope.agentName=$scope.agentNameDefault,$scope.agentDescription=$scope.agentDescriptionDefault,$scope.avatar=$scope.agentAvatarDefault,$scope.needSignin=!1,$scope.listService=[],$scope.chatMessage={},$scope.listMessage=[],$scope.listHistory=[],$scope.visitorName="",$scope.visitorEmail="",$scope.surveyVisitorName="",$scope.isLike=!1,$scope.isDislike=!1,$scope.listServiceStr="",$scope.isMobile=!1,$scope.isTypingChat=!1,$scope.isTyping=!1,$scope.isKeyPress=!1
var delayTimeout=null,isClearTimeout=!1,autoLoginTimeout=!1
$scope.isAutoPopupRequire=!1,$scope.isParentFocused=!1,$scope.chatState=null,$scope.isChangeUserInfo=!1,$scope.userInfo=new UserInfo,$scope.commentMessage=new Comment,$scope.login=new LoginUser
var timeoutTyping,userIp="",city="",messageAudio=new Audio("../images/triad_gbd.mp3"),isTouchEvent="ontouchstart"in window
getQueryString(),$scope.openChatBox=function(){isClearTimeout=!0,$scope.useFacebook?popupCenter("https://www.messenger.com/t/"+$scope.pageId,"Chat Facebook"):(notifyNewMessage("openChatBox"),$scope.maximize=!0,$scope.newMessage=0,$scope.chatState.chat_windows_maximum=!0,saveChatStateToStorage(),requestFirstLogin(),autoLoginTimeout&&clearTimeout(autoLoginTimeout),$(".chat-area").scrollTop($(".chat-area").prop("scrollHeight")))},$scope.closeChatBox=function(){isClearTimeout=!0,$scope.chatState.chat_windows_maximum=!1,$scope.maximize=!1,notifyNewMessage(hidePopup?$scope.isChatting?"closeChatBox":"closeChatBoxHide":"closeChatBox"),saveChatStateToStorage()},$scope.changeSound=function(){$scope.chatState.enableSound=!$scope.chatState.enableSound,saveChatStateToStorage()},$scope.sendLandingInfo=function(conversationId){var source=JSON.parse(getCookie("chatState_sourceUrl_"+$scope.domainId))
source.isSentBefore||(source.isSentBefore=!0,setCookie("chatState_sourceUrl_"+$scope.domainId,JSON.stringify(source)),source.conversationId=conversationId,send(CUSTOMER_UPDATE_SOURCEURL,source))},$scope.changeLandingSendState=function(state){var source=JSON.parse(getCookie("chatState_sourceUrl_"+$scope.domainId))
source.isSentBefore=state,setCookie("chatState_sourceUrl_"+$scope.domainId,JSON.stringify(source))},$scope.startTyping=function(){$scope.isTypingChat=!0},$scope.stopTyping=function(){$scope.isTypingChat=!1},$scope.startChat=function(){var name=null==$scope.login.username?"":$scope.login.username.trim(),email=null==$scope.login.email?"":$scope.login.email.trim(),phone=null==$scope.login.phone?"":$scope.login.phone.trim(),service=$scope.login.selectedService,content=$scope.login.content
if($scope.validateUser(name,email,phone),""==content?$scope.requiredContent=!0:$scope.requiredContent=!1,-1==service.serviceId?$scope.requireService=!0:$scope.requireService=!1,!($scope.requiredName||$scope.requiredEmail||$scope.invalidEmail||$scope.requiredPhone||$scope.invalidPhone||$scope.requiredContent||$scope.requireService)){if($scope.login.content="",""!=name){$scope.chatState.visitor_name=name,$scope.chatState.visitor_email=email,$scope.chatState.visitor_phone=phone,$scope.visitorName=$scope.chatState.visitor_name,$scope.visitorEmail=$scope.chatState.visitor_email,$scope.visitorPhone=$scope.chatState.visitor_phone
var infoVisitor={name:name,email:email,phone:phone}
send(UPDATE_VISITOR_INFO,infoVisitor),$scope.isSignin=!0}var sendMessage={service_id:service.serviceId,conversationId:$scope.chatState.conversation_id?$scope.chatState.conversation_id:"-1",message:content}
$scope.chatState.chatting=!0,send(MESSAGE,sendMessage),$scope.chatState.service_id=service.serviceId,saveChatStateToStorage(),$scope.isChatting=!0}},$scope.sendAnother=function(){$scope.sentNotify=!1,$scope.login.content=""},$scope.sendOffline=function(){$scope.sendOfflineError=!1
var name=null==$scope.login.username?"":$scope.login.username.trim(),email=null==$scope.login.email?"":$scope.login.email.trim(),phone=null==$scope.login.phone?"":$scope.login.phone.trim(),content=$scope.login.content,service=$scope.login.selectedService
if($scope.validateUser(name,email,phone),""==content?$scope.requiredContent=!0:$scope.requiredContent=!1,-1==service.serviceId?$scope.requireService=!0:$scope.requireService=!1,!($scope.requiredName||$scope.requiredEmail||$scope.invalidEmail||$scope.requiredPhone||$scope.invalidPhone||$scope.requiredContent||$scope.requireService)){if(""!=name){$scope.isSendOffline=!0,$scope.chatState.visitor_name=name,$scope.chatState.visitor_email=email,$scope.chatState.visitor_phone=phone
var infoVisitor={name:name,email:email,phone:phone}
send(UPDATE_VISITOR_INFO,infoVisitor)}var host=document.location.host
parent!==window&&(host=document.referrer)
var sendMessage={message:content,service_id:service.serviceId,host_name:getHostName(host),url:host}
send(CUSTOMER_SEND_OFFLINE_MESSAGE,sendMessage),saveChatStateToStorage()}},$scope.openOptionBox=function(e){$scope.isClickOption=!$scope.isClickOption,$scope.isClickSignin=!1,$scope.isClickOption?isTouchEvent||($scope.$window.onclick=function(event){closeDivWhenClickingElsewhere(event,$scope.openOptionBox,"option-menu",e)}):(isTouchEvent||($scope.$window.onclick=null),void 0==e&&$scope.$apply())},$scope.showUserInfoEdit=function(){$scope.isChangeUserInfo=!0},$scope.signout=function(){$scope.chatState.visitor_id="-1",$scope.chatState.visitor_name="",$scope.chatState.visitor_email="",$scope.chatState.visitor_phone="",$scope.login.username="",$scope.login.email="",$scope.login.phone="",$scope.userInfo.username="",$scope.userInfo.email="",$scope.userInfo.phone="",$scope.visitorName="",$scope.visitorEmail="",$scope.visitorPhone="",$scope.isChangeUserInfo=!0,saveChatStateToStorage()},$scope.openEditInfo=function(){$scope.isClickOption=!1,$scope.isClickSignin=!0,$scope.isEditUserInfo=!0,$scope.userInfo.username=$scope.visitorName,$scope.userInfo.email=$scope.visitorEmail,$scope.userInfo.phone=$scope.visitorPhone,$scope.requiredName=!1,$scope.requiredEmail=!1,$scope.requiredPhone=!1,$scope.requiredContent=!1,$scope.requireService=!1,$scope.invalidEmail=!1,$scope.invalidPhone=!1},$scope.closeEditInfo=function(){$scope.isEditUserInfo=!1,$scope.isClickSignin=!1},$scope.confirmEndChat=function(e){$scope.isConfirmEnd=!0,$scope.isClickOption=!1,isTouchEvent||($scope.$window.onclick=null),$scope.commentMessage=new Comment,isTouchEvent||($scope.$window.onclick=function(event){closeDivWhenClickingElsewhere(event,function(){$scope.isConfirmEnd=!1,$scope.$window.onclick=null,$scope.$digest()},"confirm-end",e)})},$scope.cancelEndChat=function(){$scope.isConfirmEnd=!1,$scope.isClickOption=!1,isTouchEvent||($scope.$window.onclick=null)},$scope.submitEndChat=function(){$scope.isConfirmEnd=!1,$scope.isClickOption=!1,isTouchEvent||($scope.$window.onclick=null),null!==$scope.chatState.agent_name?$scope.isRating=!0:endConversation()},$scope.skipRating=function(){endConversation()},$scope.submitRating=function(){if(""!=$scope.commentMessage.content){var comment={visitorId:$scope.chatState.visitor_id,serviceId:$scope.chatState.service_id,conversationId:$scope.chatState.conversation_id,content:$scope.commentMessage.content}
send(COMMENT,comment)}endConversation()},$scope.dislike=function(){var dislike={visitorId:$scope.chatState.visitor_id,serviceId:$scope.chatState.service_id,conversationId:$scope.chatState.conversation_id}
send(DISLIKE,dislike)},$scope.like=function(){var like={visitorId:$scope.chatState.visitor_id,serviceId:$scope.chatState.service_id,conversationId:$scope.chatState.conversation_id}
send(LIKE,like)},$scope.openSigninBox=function(e){$scope.isClickOption=!1,$scope.isClickSignin=!$scope.isClickSignin,$scope.isClickSignin?$scope.$window.onclick=function(event){closeDivWhenClickingElsewhere(event,$scope.openEditInfoBox,"sign-in-menu",e)}:($scope.$window.onclick=null,void 0==e&&$scope.$apply())},$scope.showUserInfoEditMo=function(){$scope.isEditUserInfo=!0},$scope.openEditInfoBox=function(e){$scope.isClickOption=!1,$scope.isClickSignin=!$scope.isClickSignin,$scope.isClickSignin?($scope.isEditUserInfo=!1,""==$scope.login.username?($scope.userInfo.username="",$scope.isEditUserInfo=!0,$scope.userInfo.selectedService=$scope.listService[0]):$scope.userInfo.username=$scope.visitorName,-1==$scope.chatState.service_id&&($scope.isEditUserInfo=!0,$scope.userInfo.selectedService=$scope.listService[0]),$scope.userInfo.email=$scope.visitorEmail,$scope.userInfo.phone=$scope.visitorPhone,$scope.$window.onclick=function(event){closeDivWhenClickingElsewhere(event,$scope.openEditInfoBox,"sign-in-menu",e)}):($scope.$window.onclick=null,void 0==e&&$scope.$apply())},$scope.submitChat=function(event){if(1!=$scope.isKeyPress){$scope.isKeyPress=!0
var req={conversationId:$scope.chatState.conversation_id}
send(NOTIFY_TYPING,req),keypressChatTimeout=setTimeout(function(){stopNotifyTypingToCust()},5e3)}else clearTimeout(keypressChatTimeout),keypressChatTimeout=setTimeout(function(){stopNotifyTypingToCust()},5e3)
if((13===event.which||0==event)&&""!=$scope.chatMessage.content){if(0!=event&&event.preventDefault(),""==$scope.login.username&&($scope.requireEmail||$scope.requirePhone)||-1==$scope.chatState.service_id)return void $scope.openEditInfoBox()
if(null==$scope.chatState.chatting||0==$scope.chatState.chatting){var sendMessage={service_id:$scope.chatState.service_id?$scope.chatState.service_id:-1,conversationId:$scope.chatState.conversation_id?$scope.chatState.conversation_id:"-1",message:$scope.chatMessage.content}
$scope.chatState.chatting=!0,send(MESSAGE,sendMessage)}else{var msg={service_id:$scope.chatState.service_id,conversationId:$scope.chatState.conversation_id,message:$scope.chatMessage.content}
send(MESSAGE,msg)}stopNotifyTypingToCust(),$scope.chatMessage.content="",$(".chat-area").scrollTop($(".chat-area").prop("scrollHeight"))}},$scope.onClickSubmitChat=function(event){if(""!=$scope.chatMessage.content){if(""==$scope.login.username&&($scope.requireEmail||$scope.requirePhone)||-1==$scope.chatState.service_id)return void $scope.openEditInfoBox()
if(null==$scope.chatState.chatting||0==$scope.chatState.chatting){var sendMessage={service_id:$scope.chatState.service_id?$scope.chatState.service_id:-1,conversationId:$scope.chatState.conversation_id?$scope.chatState.conversation_id:"-1",message:$scope.chatMessage.content}
$scope.chatState.chatting=!0,send(MESSAGE,sendMessage)}else{var msg={service_id:$scope.chatState.service_id,conversationId:$scope.chatState.conversation_id,message:$scope.chatMessage.content}
send(MESSAGE,msg)}stopNotifyTypingToCust(),$scope.chatMessage.content="",$("#chat-text-area").focus(),$(".chat-area").scrollTop($(".chat-area").prop("scrollHeight"))}},$scope.validateUser=function(name,email,phone){""==name?$scope.requiredName=!0:$scope.requiredName=!1,$scope.requireEmail&&(""==email?$scope.requiredEmail=!0:$scope.requiredEmail=!1),isValidEmailAddress(email)||""==email?$scope.invalidEmail=!1:$scope.invalidEmail=!0,$scope.requirePhone&&(""==phone?$scope.requiredPhone=!0:$scope.requiredPhone=!1),isValidPhoneNumber(phone)||""==phone?$scope.invalidPhone=!1:$scope.invalidPhone=!0},$scope.editUserInfo=function(){var name=null==$scope.userInfo.username?"":$scope.userInfo.username.trim(),email=null==$scope.userInfo.email?"":$scope.userInfo.email.trim(),phone=null==$scope.userInfo.phone?"":$scope.userInfo.phone.trim()
if($scope.listService.length>1)var service=$scope.userInfo.selectedService
if($scope.validateUser(name,email,phone),$scope.listService.length>1&&(-1==service.serviceId?$scope.requireService=!0:$scope.requireService=!1),!($scope.requiredName||$scope.requiredEmail||$scope.invalidEmail||$scope.requiredPhone||$scope.invalidPhone||$scope.requireService)){$scope.chatState.visitor_name=name,$scope.chatState.visitor_email=email,$scope.chatState.visitor_phone=phone,$scope.listService.length>1&&($scope.chatState.service_id=service.serviceId),$scope.isSignin=!0,$scope.visitorName=$scope.chatState.visitor_name,$scope.visitorEmail=$scope.chatState.visitor_email,$scope.visitor_phone=$scope.chatState.visitor_phone,$scope.login.username=$scope.chatState.visitor_name,$scope.login.email=$scope.chatState.visitor_email,$scope.login.phone=$scope.chatState.visitor_phone,$scope.isClickSignin=!1,$scope.$window.onclick=null,$scope.isEditInfo=!1,saveChatStateToStorage()
var infoVisitor={name:name,email:email,phone:phone}
send(UPDATE_VISITOR_INFO,infoVisitor)}},$scope.onFileSelected=function(scope){var file=scope.myFile
return $scope.isClickOption=!1,$scope.$window.onclick=null,file.size>3145728?void alert($filter("translate")("LBL_FILE_SIZE")):0==/.*\.(png|jpg|jpeg|gif|doc|docx|txt|rtf|pdf|xls|xlsx|csv)$/.test(file.name.toLowerCase())?void alert($filter("translate")("LBL_CHAT_UPLOAD_ERR_EXTENSION")):void $scope.uploadFile(file,uploadUrl,"")},$scope.uploadOnSelect=function(file){void 0!=file&&null!=file&&Upload.upload({url:uploadUrl,data:{fileUp:file}}).then(function(resp){log("Success "+resp.config.data.file.name+"uploaded. Response: "+resp.data)},function(resp){log("Error status: "+resp.status)},function(evt){log("progress: "+progressPercentage+"% "+evt.config.data.file.name)})},$scope.test=function(pasteEvent){var clipData=pasteEvent.clipboardData||pasteEvent.originalEvent.clipboardData
angular.forEach(clipData.items,function(item,key){if(clipData.items[key].type.match(/image.*/)){var img=clipData.items[key].getAsFile()
if(log("A image sized "+img.size+" is being uploaded."),img.size>$scope.maxUploadSize)return $.jGrowl($filter("translate")("MAX_SIZE_UPLOAD"),{theme:"error"}),!1
var fd=new FormData
fd.append("fileUp",img),""==img.name?fd.append("fileUp",img):fd.append("fileUp",img,img.name),log(img),log(angular.identity),$http.post(uploadUrl,fd,{transformRequest:angular.identity,headers:{"Content-Type":void 0}}).success(function(url){log(url)}).error(function(data){log(data)})}})},$scope.uploadFile=function(file,uploadUrl,fileName){if($scope.uploading)alert($filter("translate")("LBL_UPLOADING"))
else{$scope.uploading=!0
var fd
"undefined"==typeof FormData?($scope.uploading=!1,alert($filter("translate")("LBL_BROWSER_NOT_SUPPORT"))):(fd=new FormData,""==fileName?fd.append("fileUp",file):fd.append("fileUp",file,fileName),$http.post(uploadUrl,fd,{transformRequest:angular.identity,headers:{"Content-Type":void 0}}).then(function(result){if(0==result.data.result)$scope.uploading=!1,alert($filter("translate")("LBL_UPLOAD_FAIL"))
else{var uploadMessage={conversationId:$scope.chatState.conversation_id,fileId:result.data.fileId,fileName:result.data.fileName,url:result.data.url}
send(SEND_FILE,uploadMessage)}},function(){$scope.uploading=!1,alert($filter("translate")("LBL_UPLOAD_FAIL"))}))}},$scope.reconnect=function(){$scope.connecting=!0,webPush.connect(CS_WEB_PUSH,0),restoreChatState()},webPush.onMessageReceived=function(dataReceived){log("Server response: "+JSON.stringify(dataReceived))
var mes,data=dataReceived.data,type=dataReceived.type
switch(type){case CUSTOMER_LOGIN:null!=data.name&&($scope.visitorName=data.name),null!=data.email&&($scope.visitorEmail=data.email),$scope.chatState.visitor_id=data.userId,isFirstLogin=!0,saveChatStateToStorage(),$scope.$digest()
break
case MESSAGE:if($scope.chatState.conversation_id=data.conversationId,data.needShow===!0){var msgData=new Message(null,1,data.message),msg=new Message(null,1,getMessageChat(data.message))
$scope.chatState.history.push(msgData),$scope.listMessage.push(msg)}$scope.sendLandingInfo(data.conversationId),$scope.$digest(),saveChatStateToStorage(),$(".chat-area").scrollTop($(".chat-area").prop("scrollHeight"))
break
case HAVE_MESSAGE:if(data.conversationId==$scope.chatState.conversation_id){1==$scope.chatState.enableSound&&messageAudio.play()
var content=data.message,fromName=data.fromFullname,senderAgentId=fromName,msgData=new Message(senderAgentId,2,content),logChatData=new Message(senderAgentId,2,getMessageChat(content))
$scope.chatState.history.push(msgData),$scope.maximize||$scope.newMessage++,$scope.listMessage.push(logChatData),saveChatStateToStorage(),$scope.$digest(),$(".chat-area").scrollTop($(".chat-area").prop("scrollHeight")),$scope.openChatBox()}break
case USER_JOIN_CONVERSATION:mes=data.username+$filter("translate")("LBL_JOIN_CHAT")
var logChatData=new Message(null,3,mes)
$scope.chatState.history.push(logChatData),$scope.listMessage.push(logChatData),saveChatStateToStorage(),$scope.$digest(),$(".chat-area").scrollTop($(".chat-area").prop("scrollHeight"))
break
case AGENT_END_CONVERSATION_CUSTOMER:mes=data.fullName+$filter("translate")("LBL_END_CHAT")
var logChatData=new Message(null,3,mes)
$scope.chatState.history.push(logChatData),$scope.listMessage.push(logChatData),$scope.chatState.agent_name=null,$scope.chatState.agent_group=null,saveChatStateToStorage(),$scope.allowRating=!1,$scope.isTyping=!1,$scope.agentName=$scope.agentNameDefault,$scope.agentDescription=$scope.agentDescriptionDefault,$scope.avatar=$scope.agentAvatarDefault,$scope.changeLandingSendState(!1),$scope.$digest(),$(".chat-area").scrollTop($(".chat-area").prop("scrollHeight"))
break
case AGENT_INFO_CUSTOMER:if($scope.chatState.agent_name!=data.fullName){$scope.chatState.agent_name=data.fullName,$scope.chatState.agent_group=data.service_name,$scope.chatState.agent_avatar=data.avatar,$scope.agentName=data.fullName,$scope.agentDescription=data.service_name,$scope.avatar=data.avatar,mes=data.fullName+$filter("translate")("LBL_JOIN_CHAT")
var logChatData=new Message(null,3,mes)
$scope.chatState.history.push(logChatData),$scope.listMessage.push(logChatData),saveChatStateToStorage(),$scope.allowRating=!0,$scope.$digest(),$(".chat-area").scrollTop($(".chat-area").prop("scrollHeight"))}break
case TRANSFER_CHAT_RESPONSE:mes=$scope.chatState.agent_name+$filter("translate")("LBL_LEAVE_CHAT")
var logChatData=new Message(null,3,mes)
$scope.chatState.history.push(logChatData),$scope.listMessage.push(logChatData),$scope.chatState.agent_name=data.fullName,$scope.chatState.agent_group=data.service_name,$scope.agentName=data.fullName,$scope.agentDescription=data.service_name,$scope.avatar=data.avatar,mes=data.fullName+$filter("translate")("LBL_JOIN_CHAT")
var logChatData=new Message(null,3,mes)
$scope.chatState.history.push(logChatData),$scope.listMessage.push(logChatData),saveChatStateToStorage(),$scope.$digest(),$(".chat-area").scrollTop($(".chat-area").prop("scrollHeight"))
break
case CHAT_SUPER_SUPPORT_END:mes=data.fullName+$filter("translate")("LBL_LEAVE_CHAT")
var logChatData=new Message(null,3,mes)
$scope.chatState.history.push(logChatData),$scope.listMessage.push(logChatData),saveChatStateToStorage(),$scope.$digest(),$(".chat-area").scrollTop($(".chat-area").prop("scrollHeight"))
break
case SUPPORT_CHAT_RESPONSE:mes=data.fullName+$filter("translate")("LBL_JOIN_CHAT")
var logChatData=new Message(null,3,mes)
$scope.chatState.history.push(logChatData),$scope.listMessage.push(logChatData),saveChatStateToStorage(),$scope.$digest(),$(".chat-area").scrollTop($(".chat-area").prop("scrollHeight"))
break
case RESPONSE_AGENT_MISS_CHAT_TO_CUSTOMER:var logChatData=new Message(null,3,$scope.agentBusyDefault)
$scope.chatState.history.push(logChatData),$scope.listMessage.push(logChatData),$scope.changeLandingSendState(!1),$scope.$digest(),$(".chat-area").scrollTop($(".chat-area").prop("scrollHeight"))
break
case CUSTOMER_RESUMING_RESPONSE:var res=data.r
if(1==res){restoreChatBox(),$scope.isOffline=!1
var host=document.location.host
parent!==window&&(host=document.referrer)
var url={url:host,title:$scope.pageTitle?$scope.pageTitle:null,referrer:$scope.referrer?$scope.pageTitle:null}
send(VISITOR_VISIT_PATH_URL,url)}else if(-2==res)$scope.maximize=!1,$scope.isOffline=!0,sessionLogout(),notifyNewMessage(hidePopup?$scope.isChatting?"closeChatBox":"closeChatBoxHide":"closeChatBox"),saveChatStateToStorage(),"support"==$scope.domainCode&&setTimeout(function(){restoreChatState()},3e5)
else{if(isFirstLogin=!1,$scope.maximize=!1,$scope.isOffline=!1,log("resuming session failed"),sessionLogout(),notifyNewMessage(hidePopup?$scope.isChatting?"closeChatBox":"closeChatBoxHide":"closeChatBox"),$scope.autoPopup){var needPopup=!1
if(0==$scope.autoType)""==$scope.login.username&&(needPopup=!0)
else if(2==$scope.autoType)needPopup=!0
else if(1==$scope.autoType)if(null==$scope.chatState.lastPopupTime)needPopup=!0,$scope.chatState.lastPopupTime=(new Date).getTime()
else{var curTime=(new Date).getTime()
curTime-$scope.chatState.lastPopupTime>60*$scope.autoTime*1e3&&(needPopup=!0,$scope.chatState.lastPopupTime=curTime)}needPopup&&0!=isAuto&&!$scope.isMobile&&(delayTimeout=setTimeout(function(){if(!isClearTimeout){""!=$scope.login.username?$scope.isSignin=!0:$scope.isSignin=!1,$scope.isMobile?$scope.newMessage++:(notifyNewMessage("openChatBox"),$scope.maximize=!0)
var content=$scope.autoMessage,fromName=$scope.autoName,senderAgentId=fromName,msgData=new Message(senderAgentId,2,content),logChatData=new Message(senderAgentId,2,getMessageChat(content))
$scope.chatState.history.push(msgData),$scope.listMessage.push(logChatData),$scope.isChatting=!0,null!=localStorage.getItem("chatState_devicekey_"+$scope.domainId)?setTimeout(function(){requestFirstLogin()},1e3):requestFirstLogin()}},1e3*$scope.autoDelay))}else autoLoginTimeout=setTimeout(function(){requestFirstLogin()},5e3)
!$scope.requireEmail&&!$scope.requirePhone&&""!=$scope.login.username&&$scope.listService.length<=1&&($scope.isSignin=!0),saveChatStateToStorage()}$scope.listService.length>1&&($scope.listService[0].serviceName=$filter("translate")("LBL_SELECT_ONE_SERVICE")),$scope.chat=!0,$scope.$digest(),$(".chat-area").scrollTop($(".chat-area").prop("scrollHeight"))
break
case AGENT_LOGOUT:mes=data.fullName+$filter("translate")("LBL_LEAVE_CHAT")
var logChatData=new Message(null,3,mes)
$scope.chatState.history.push(logChatData),$scope.listMessage.push(logChatData),$scope.$digest(),$scope.isTyping=!1,$(".chat-area").scrollTop($(".chat-area").prop("scrollHeight"))
break
case LIKE:var res=data.r
if(1===res){var rating=data.rating
if(0===rating){$scope.isLike=!1,$scope.isDislike=!1
var logChatData=new Message(null,3,$filter("translate")("LBL_CHAT_REMOVE"))
$scope.chatState.history.push(logChatData),$scope.listMessage.push(logChatData),$scope.chatState.isLike=!1,saveChatStateToStorage()}else{$scope.isLike=!0,$scope.isDislike=!1
var logChatData=new Message(null,3,$filter("translate")("LBL_CHAT_GOOD"))
$scope.chatState.history.push(logChatData),$scope.listMessage.push(logChatData),$scope.chatState.isLike=!0,$scope.chatState.isDislike=!1,saveChatStateToStorage()}}else log("Rating failed")
$scope.$digest(),$(".chat-area").scrollTop($(".chat-area").prop("scrollHeight"))
break
case DISLIKE:var res=data.r
if(1===res){var rating=data.rating
if(0===rating){$scope.isLike=!1,$scope.isDislike=!1
var logChatData=new Message(null,3,$filter("translate")("LBL_CHAT_REMOVE"))
$scope.chatState.history.push(logChatData),$scope.listMessage.push(logChatData),$scope.chatState.isDislike=!1,saveChatStateToStorage()}else{$scope.isLike=!1,$scope.isDislike=!0
var logChatData=new Message(null,3,$filter("translate")("LBL_CHAT_BAD"))
$scope.chatState.history.push(logChatData),$scope.listMessage.push(logChatData),$scope.chatState.isLike=!1,$scope.chatState.isDislike=!0,saveChatStateToStorage()}}else log("Rating failed")
$scope.$digest(),$(".chat-area").scrollTop($(".chat-area").prop("scrollHeight"))
break
case SEND_FILE:var res=data.res
if(1==res){var logChatData=new Message(null,4,"")
logChatData.fileName=data.fileName,logChatData.url=data.url,isImageLink(data.fileName)&&(logChatData.isImage=1),$scope.chatState.history.push(logChatData),$scope.listMessage.push(logChatData),saveChatStateToStorage()}$scope.uploading=!1,$scope.$digest(),$(".chat-area").scrollTop($(".chat-area").prop("scrollHeight"))
break
case RECEIVE_FILE:var logChatData=new Message(data.fromFullname,4,"")
logChatData.fileName=data.fileName,logChatData.url=data.url,isImageLink(data.fileName)&&(logChatData.isImage=1),$scope.maximize||$scope.newMessage++,$scope.chatState.history.push(logChatData),$scope.listMessage.push(logChatData),saveChatStateToStorage(),$scope.$digest(),$(".chat-area").scrollTop($(".chat-area").prop("scrollHeight"))
break
case LEAVE_CONVERSATION:if(data.conversationId==$scope.chatState.conversation_id){$scope.chatState.conversation_id="-1",$scope.chatState.agent_name=null
var mes=$filter("translate")("LBL_CHAT_ENDED"),logChatData=new Message(null,3,mes)
$scope.isRating=!1,$scope.allowRating=!1,$scope.isLike=!1,$scope.isDislike=!1,$scope.chatState.isLike=!1,$scope.chatState.isDislike=!1,$scope.commentMessage.content="",$scope.agentName=$scope.agentNameDefault,$scope.agentDescription=$scope.agentDescriptionDefault,$scope.avatar=$scope.agentAvatarDefault}$scope.$digest(),$(".chat-area").scrollTop($(".chat-area").prop("scrollHeight"))
break
case CUSTOMER_SEND_OFFLINE_MESSAGE:1==data.r?$scope.sentNotify=!0:$scope.sendOfflineError=!0,$scope.isSendOffline=!1,$scope.$digest()
break
case NOTIFY_TYPING:$scope.isTyping=!0,timeoutTyping=setTimeout(function(){$scope.isTyping=!1,$scope.$digest()},15e3),$scope.$digest(),$(".chat-area").scrollTop($(".chat-area").prop("scrollHeight"))
break
case NOTIFY_STOP_TYPING:$scope.isTyping=!1,clearTimeout(timeoutTyping),$scope.$digest(),$(".chat-area").scrollTop($(".chat-area").prop("scrollHeight"))
break
case AGENT_START_CHAT_WITH_CUSTOMER:if($scope.chatState.agent_name!=data.fullName){$scope.chatState.conversation_id=data.conversationId,$scope.chatState.agent_name=data.fullName,$scope.chatState.agent_group=data.serviceName,$scope.chatState.service_id=data.serviceId,$scope.chatState.chatting=!0,$scope.agentName=data.fullName,$scope.agentDescription=data.serviceName,$scope.avatar=data.avatar,mes=data.fullName+$filter("translate")("LBL_JOIN_CHAT")
var logChatData=new Message(null,3,mes)
$scope.chatState.history.push(logChatData),$scope.listMessage.push(logChatData),saveChatStateToStorage(),$scope.allowRating=!0,$scope.isChatting=!0,$scope.listService=[],""!=$scope.login.username&&($scope.isSignin=!0),$scope.openChatBox(),$scope.$digest(),$(".chat-area").scrollTop($(".chat-area").prop("scrollHeight"))}}},window.addEventListener?window.addEventListener("message",displayMessage,!1):window.attachEvent("onmessage",displayMessage)}])
